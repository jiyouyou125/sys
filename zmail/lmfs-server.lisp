;;;-*- Mode:LISP; Package:ZWEI-*-ç;;; Mail server for the local file systemç;;; ** (c) Copyright 1981 Massachusetts Institute of Technology **ç;;; ** (c) Enhancements copyright 1981 Symbolics, Inc. **çç;;; For now only allow mail from one place at a time.ç(DEFVAR *MAIL-SERVER-LOCK* NIL)çç(DEFUN MAIL-SERVER (&AUX LOCK CONN STREAM (USER-ID USER-ID))ç  (SETQ LOCK (LOCF *MAIL-SERVER-LOCK*))ç  (CATCH-ERRORç    (UNWIND-PROTECTç      (PROG TOP ()çâ    (AND (EQUAL USER-ID "") (SETQ USER-ID "Mail-server"))çâ    (PROCESS-LOCK LOCK)çâ    (SETQ CONN (CHAOS:LISTEN "MAIL"))çâ    (CHAOS:ACCEPT CONN)çâ    (FUNCALL TV:WHO-LINE-FILE-STATE-SHEET ':ADD-SERVER CONN "MAIL")çâ    (SETQ STREAM (CHAOS:STREAM CONN))çâ    (LET* ((RECIPIENTS (READ-MAIL-RECIPIENTS STREAM))çââ   (TEXT (GET-MAIL-TEXT STREAM)))çâ      (DOLIST (RECIPIENT RECIPIENTS)çââ(LET ((PATHNAME (FS:MAKE-PATHNAME ':HOST "local"çââââââ  ':DIRECTORY (STRING-APPEND #/> RECIPIENT)çââââââ  ':NAME "MAIL"çââââââ  ':TYPE "TEXT"çââââââ  ':VERSION ':NEWEST)))çââ(WITH-OPEN-FILE (OUTFILE PATHNAME '(:OUT :NOERROR))çââ  (COND ((STRINGP OUTFILE)çâââ (FORMAT STREAM "-Unexpected error for ~A: ~A~%" RECIPIENT OUTFILE)çâââ (FUNCALL STREAM ':FORCE-OUTPUT)çâââ (RETURN-FROM TOP)))çââ  ;; This always appends new mail.  ZMail knows how to reverse it after all.çââ  (WITH-OPEN-FILE (INFILE PATHNAME '(:IN :NOERROR))çââ    (IF (STRINGP INFILE)çâââ(MULTIPLE-VALUE-BIND (ERR NIL MSG)çâââ    (FS:FILE-PROCESS-ERROR INFILE PATHNAME NIL T)çâââ  (IF (STRING-EQUAL ERR "FNF")çâââ      ;; If this is the first file, make there only be one copyçâââ      (FS:CHANGE-FILE-PROPERTIES PATHNAME NILçâââââââ ':GENERATION-RETENTION-COUNT 1)çâââ      (FORMAT STREAM "-Unexpected error for ~A: ~A~%" RECIPIENT MSG)çâââ      (FUNCALL STREAM ':FORCE-OUTPUT)çâââ      (RETURN-FROM TOP)))çâââ(STREAM-COPY-UNTIL-EOF INFILE OUTFILE)))çââ  (FUNCALL OUTFILE ':STRING-OUT TEXT)çââ  (FUNCALL OUTFILE ':LINE-OUT "")))))çâ    (FORMAT STREAM "+Message sent successfully.~%")çâ    (FUNCALL STREAM ':FORCE-OUTPUT)çâ    (FUNCALL STREAM ':FINISH)çâ    (FUNCALL STREAM ':CLOSE))ç      (AND CONN (CHAOS:REMOVE-CONN CONN))ç      (PROCESS-UNLOCK LOCK))ç    NIL))çç(DEFUN READ-MAIL-RECIPIENTS (STREAM)ç  (DO ((LINE)ç       (RECIPIENTS NIL)ç       (AT-POS))ç      (NIL)ç    (SETQ LINE (FUNCALL STREAM ':LINE-IN))ç    (AND (EQUAL LINE "") (RETURN (NREVERSE RECIPIENTS)))ç    (AND (SETQ AT-POS (STRING-SEARCH-CHAR #/@ LINE))çâ (= (CHAOS:ADDRESS-PARSE (SUBSTRING LINE (1+ AT-POS))) CHAOS:MY-ADDRESS)çâ (SETQ LINE (SUBSTRING LINE 0 AT-POS)))ç    (IF (NOT (PROBEF (FS:MAKE-PATHNAME ':HOST "local"çââââ       ':DIRECTORY ">"çââââ       ':NAME LINEçââââ       ':TYPE ':DIRECTORYçââââ       ':VERSION 1)))çâ(FORMAT STREAM "-Unknown user ~A.~%" LINE)çâ(PUSH LINE RECIPIENTS)çâ(FORMAT STREAM "+Recipient name ~A ok.~%" LINE))ç    (FUNCALL STREAM ':FORCE-OUTPUT)))çç(DEFUN GET-MAIL-TEXT (STREAM)ç  (WITH-OUTPUT-TO-STRING (SSTREAM)ç    (STREAM-COPY-UNTIL-EOF STREAM SSTREAM)ç    (FUNCALL SSTREAM ':FRESH-LINE)))çç(ADD-INITIALIZATION "MAIL"ç                    '(PROCESS-RUN-TEMPORARY-FUNCTION "MAIL Server" 'MAIL-SERVER)ç                    NILç                    'CHAOS:SERVER-ALIST)ç